name: CMake Build

on:
  push:
  workflow_dispatch:

jobs:
  build-win:
    name: Win Build
    runs-on: windows-2019
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - uses: ilammy/msvc-dev-cmd@v1
        with:
          vsversion: 2019
# At this time, latest awvwgk/setup-fortran works well, but it's not released to github actions.
# Until the next release, the source will be directly fetched and used.
      # - uses: awvwgk/setup-fortran@v1.1
      #   id: setup-fortan
      #   with:
      #     compiler: intel-classic
      #     version: 2021.10.0
      - name: Clone Setup-Fortran
        run: |
          git clone https://github.com/z-ichinohe/setup-fortran
      - name: Setup Fortran
        id: setup-fortran
        uses: ./setup-fortran
        with:
          compiler: intel
          version: 2022.2.0
      - name: Install MUMPS and CONAN
        shell: pwsh
        run: |
            pip install conan==1.59.0
      - name: Build
        shell: pwsh
        run: |
          & "C:\Program Files (x86)\Intel\oneAPI\setVars" intel64 mod
          ifort /QV
          cd D:\a\OpenSees\OpenSees
          mkdir build
          cd build
          conan install .. --build missing --settings compiler="Visual Studio" --settings compiler.runtime="MT" --settings compiler.version=16
          cmake ..
          cmake --build . --config Release --target OpenSees -j8
          cmake --build . --config Release --target OpenSeesPy -j8
          mv ./bin/OpenSeesPy.dll ./bin/opensees.pyd
      - name: Verification OpenSeesPySP
        shell: pwsh
        run: |
          cd ./EXAMPLES/ExamplePython/
          $env:PYTHONPATH = "../../build/bin/"
          python -c "import sys; print(sys.path)"
          python example_variable_analysis.py
