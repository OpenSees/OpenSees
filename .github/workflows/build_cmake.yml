name: CMake Build

env:
  CMAKE_VERSION: 3.27.3
  BUILD_TYPE: Release

on:
  push:
    branches: [master]

  pull_request:
    branches: [master]

  workflow_dispatch:
    
jobs:
  build-ubuntu:
    name: Ubuntu bundled build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        
    - name: Install conan
      run: python3 -m pip install conan==2.0.9

    - name: Detect Conan Defaults
      run: |
        conan --version
        conan profile detect

    - name: Build
      run: |
        mkdir build
        conan install . --build missing
        cd build
        cmake .. -DCMAKE_PROJECT_TOP_LEVEL_INCLUDES="/cmake/cmake/conan_provider.cmake"
        cmake --build . -j 8

        #- name: Verification
        #  run: |
        #    cd ./EXAMPLES/verification/ && ../../build/OpenSeesTcl runVerificationSuite.tcl
    - name: Build OpenSeesPy
      run: |
        cd ./build
        cmake .. -DCMAKE_PROJECT_TOP_LEVEL_INCLUDES="/cmake/cmake/conan_provider.cmake"
        make -j 4
        make OpenSeesPy
        mkdir fake_folder
    - name: Rename OpenSeesPy
      run: |
        cd ./build
        mv lib/OpenSeesPy.so lib/opensees.so

# Simple sanity test
    - name: Verification OpenSeesPySP
      run: |
        cd ./build
        cd ../EXAMPLES/ExamplePython/
        export PYTHONPATH="../../build/lib/"
        python -c "import sys; print(sys.path)"
        python example_variable_analysis.py
#        # Simple MP sanity test
#        - name: Verification OpenSeesPyMP
#          run: |
#            mpiexec -np 2 python ../EXAMPLES/ExamplePython/example_mpi_paralleltruss_explicit.py

# Not building on Windows until we can figure out how to use Fortran
# with Github Actions
    #  build-win32:
    #    name: Build on Windows
    #    runs-on: [windows-latest]
    #    steps:
    #    - name: Checkout sources
    #      uses: actions/checkout@v2
    #      with: {ref: cmake-build}
    #    
    #    - name: Install Conan
    #      uses: turtlebrowser/get-conan@main
    #
    #    - name: Build
    #      run: |
    #        mkdir build
    #        cd build
    #        cmake ..
    #        cmake --build . --target OpenSeesTcl -j5


